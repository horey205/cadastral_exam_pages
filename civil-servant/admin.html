<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëª¨ë“œ - ì§€ì ê³µë¬´ì› ë¬¸ì œì€í–‰</title>
    <link rel="stylesheet" href="style.css">
    <script src="questions.js"></script>
    <style>
        :root {
            --admin-primary: #ec4899;
        }

        .admin-nav {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .admin-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            margin-left: 100px;
            /* Sidebar space */
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .q-list {
            height: 80vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .category-header {
            padding: 10px;
            font-weight: bold;
            color: var(--admin-primary);
            border-bottom: 2px solid var(--admin-primary);
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-card {
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
        }

        .admin-card:hover {
            border-color: var(--admin-primary);
            background: rgba(236, 72, 153, 0.05);
        }

        .admin-card.active {
            border-color: var(--admin-primary);
            background: rgba(236, 72, 153, 0.1);
        }

        .editor-panel {
            position: sticky;
            top: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .badge.ìƒ {
            background: #ef4444;
        }

        .badge.ì¤‘ {
            background: #f59e0b;
        }

        .badge.í•˜ {
            background: #10b981;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        #save-status {
            font-size: 0.8rem;
            color: #10b981;
            margin-top: 10px;
        }

        .edit-q-image {
            margin: 10px 0;
            text-align: center;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed var(--glass-border);
        }

        .edit-q-image img {
            max-width: 100%;
            max-height: 200px;
        }

        .no-img-msg {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .save-btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
    </style>
</head>

<body class="dark-mode">
    <div id="login-overlay" class="screen"
        style="display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: var(--background);">
        <div class="glass card" style="width: 320px; padding: 40px; text-align: center;">
            <h2 style="margin-bottom: 30px;">Admin Login</h2>
            <div class="form-group" style="text-align: left;">
                <label>ID</label>
                <input type="text" id="admin-id" placeholder="ID ì…ë ¥">
            </div>
            <div class="form-group" style="text-align: left; margin-bottom: 30px;">
                <label>Password</label>
                <input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>
            <button class="primary-btn" style="background:var(--admin-primary); width: 100%;"
                onclick="checkLogin()">ë¡œê·¸ì¸</button>
            <p id="login-error" style="color: var(--wrong); font-size: 0.8rem; margin-top: 15px;"></p>
        </div>
    </div>

    <!-- Wrap existing content in a dashboard div -->
    <div id="admin-dashboard" class="hidden">
        <nav class="admin-nav glass">
            <h2 style="font-size:1.2rem;">Admin <span style="color:var(--admin-primary)">Dashboard</span></h2>
            <div class="nav-actions" style="display:flex; gap: 10px; align-items: center;">
                <button class="primary-btn"
                    style="background:var(--admin-primary); padding: 8px 12px; font-size: 0.8rem;"
                    onclick="document.getElementById('import-modal').classList.remove('hidden')">ğŸš€ AI ëŒ€ëŸ‰ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="primary-btn"
                    style="background:var(--admin-primary); padding: 8px 12px; font-size: 0.8rem;"
                    onclick="addNewQuestion()">+ 1ê±´ ì¶”ê°€</button>
                <button class="glass-btn" style="padding: 10px 15px;" onclick="location.href='index.html'">ì¢…ë£Œ</button>
            </div>
        </nav>

        <!-- Quick Menu Sidebar -->
        <div class="sidebar-menu glass"
            style="position:fixed; left:20px; top:100px; bottom:20px; width:60px; display:flex; flex-direction:column; gap:10px; padding:10px; align-items:center; z-index:90;">
            <div title="ê¸°ì¶œ(ì¸¡ëŸ‰)" onclick="scrollToCategory('off_survey')"
                style="width:40px; height:40px; border-radius:50%; background:#10b981; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                ì¸¡ëŸ‰</div>
            <div title="ê¸°ì¶œ(ì „ì‚°)" onclick="scrollToCategory('off_cs')"
                style="width:40px; height:40px; border-radius:50%; background:#3b82f6; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                ì „ì‚°</div>
            <div title="ì‹ ê·œ(ì¸¡ëŸ‰)" onclick="scrollToCategory('cust_survey')"
                style="width:40px; height:40px; border-radius:50%; background:#ec4899; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                AIì¸¡</div>
            <div title="ì‹ ê·œ(ì „ì‚°)" onclick="scrollToCategory('cust_cs')"
                style="width:40px; height:40px; border-radius:50%; background:#f59e0b; cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                AIì „</div>
        </div>

        <div class="admin-container">
            <div class="q-list" id="question-list">
                <!-- Sorted Categories Injected Here -->
            </div>

            <div class="editor-panel glass card">
                <h3>ë¬¸ì œ í¸ì§‘ê¸°</h3>
                <div id="editor-form" class="hidden">
                    <input type="hidden" id="edit-id">
                    <div class="form-group">
                        <label>ì§ˆë¬¸ í…ìŠ¤íŠ¸</label>
                        <textarea id="edit-text" rows="4"></textarea>
                    </div>
                    <div class="form-group" style="display:flex; gap:10px;">
                        <div style="flex:1">
                            <label>ê³¼ëª©</label>
                            <select id="edit-subject">
                                <option value="ì§€ì ì¸¡ëŸ‰">ì§€ì ì¸¡ëŸ‰</option>
                                <option value="ì§€ì ì „ì‚°í•™ê°œë¡ ">ì§€ì ì „ì‚°í•™ê°œë¡ </option>
                            </select>
                        </div>
                        <div style="flex:1">
                            <label>ì¶œì²˜</label>
                            <select id="edit-source">
                                <option value="ê¸°ì¶œ">ê¸°ì¶œë¬¸ì œ</option>
                                <option value="AI">AI ìƒì„±</option>
                                <option value="ì˜ˆìƒ">ì§ì ‘ ì˜ˆìƒë¬¸ì œ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì´ë¯¸ì§€ í™•ì¸ ë° ìˆ˜ì •</label>
                        <div id="edit-img-preview" class="edit-q-image"></div>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="edit-image" placeholder="images/..." style="flex: 1;">
                            <input type="file" id="file-uploader" style="display: none;"
                                onchange="handleFileSelect(this)">
                            <button class="glass-btn" style="font-size:0.8rem;"
                                onclick="document.getElementById('file-uploader').click()">íŒŒì¼</button>
                        </div>
                    </div>
                    <div class="form-group" style="display:flex; gap:10px;">
                        <div style="flex:1"><label>ë‚œì´ë„</label>
                            <select id="edit-difficulty">
                                <option value="ìƒ">ìƒ</option>
                                <option value="ì¤‘">ì¤‘</option>
                                <option value="í•˜">í•˜</option>
                            </select>
                        </div>
                        <div style="flex:1"><label>ì •ë‹µ (1-4)</label><input type="number" id="edit-answer" min="1"
                                max="4"></div>
                    </div>
                    <div class="form-group">
                        <label>í•´ì„¤</label>
                        <textarea id="edit-explanation" rows="6"></textarea>
                    </div>
                    <button class="primary-btn" style="background:var(--admin-primary)" onclick="saveChanges()">ë³€ê²½ì‚¬í•­
                        ì €ì¥</button>
                    <div id="save-status"></div>
                </div>
                <div id="no-selection" style="text-align:center; color:var(--text-muted); margin-top:50px;">ë¬¸ì œë¥¼ ì„ íƒí•˜ì„¸ìš”.
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="import-modal" class="screen hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center;">
        <div class="glass card"
            style="width: 90%; max-width: 800px; padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
            <div style="border-right: 1px solid var(--glass-border); padding-right: 20px;">
                <h3 style="color: var(--admin-primary); margin-bottom: 20px;">ğŸ¤– AI ê°€ì ¸ì˜¤ê¸° (ê³¼ëª© ì§€ì •)</h3>
                <div class="form-group">
                    <label>ê°€ì ¸ì˜¬ ë¬¸ì œì˜ ê³¼ëª© ì„ íƒ</label>
                    <select id="import-subject" style="background:#000;">
                        <option value="ì§€ì ì¸¡ëŸ‰">ì§€ì ì¸¡ëŸ‰</option>
                        <option value="ì§€ì ì „ì‚°í•™ê°œë¡ ">ì§€ì ì „ì‚°í•™ê°œë¡ </option>
                    </select>
                </div>
                <div
                    style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 20px; font-size:0.75rem;">
                    <p style="font-weight:700; color:#10b981;">[JSON í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ]</p>
                    <p>ë‚´ìš©ì„ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œ ìš”ì²­í•˜ì„¸ìš”. "answer"ëŠ” 1~4 ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.</p>
                </div>
                <button class="glass-btn"
                    onclick="document.getElementById('import-modal').classList.add('hidden')">ì·¨ì†Œ</button>
            </div>
            <div style="display: flex; flex-direction: column;">
                <h3>ğŸš€ JSON ë¶™ì—¬ë„£ê¸°</h3>
                <textarea id="import-area"
                    style="flex: 1; min-height: 250px; background: rgba(0,0,0,0.3); color: #10b981; font-family: monospace; padding: 10px; border-radius: 8px;"
                    placeholder="[...]"></textarea>
                <button class="primary-btn" style="background: var(--admin-primary); margin-top:10px;"
                    onclick="processImport()">ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <script>
        let data = {
            off_survey: [], off_cs: [], cust_survey: [], cust_cs: []
        };
        let currentEdit = { cat: '', idx: -1 };

        if (typeof questionData !== 'undefined') {
            data.off_survey = questionData.filter(q => q.source === 'ê¸°ì¶œ' && q.subject === 'ì§€ì ì¸¡ëŸ‰');
            data.off_cs = questionData.filter(q => q.source === 'ê¸°ì¶œ' && q.subject === 'ì§€ì ì „ì‚°í•™ê°œë¡ ');
            data.cust_survey = questionData.filter(q => q.source !== 'ê¸°ì¶œ' && q.subject === 'ì§€ì ì¸¡ëŸ‰');
            data.cust_cs = questionData.filter(q => q.source !== 'ê¸°ì¶œ' && q.subject === 'ì§€ì ì „ì‚°í•™ê°œë¡ ');
            renderList();
        }

        function renderList() {
            const list = document.getElementById('question-list');
            let html = '';
            const configs = [
                { id: 'off_survey', title: 'ğŸ›ï¸ ê¸°ì¶œ (ì§€ì ì¸¡ëŸ‰)', color: '#10b981' },
                { id: 'off_cs', title: 'ğŸ›ï¸ ê¸°ì¶œ (ì§€ì ì „ì‚°)', color: '#3b82f6' },
                { id: 'cust_survey', title: 'ğŸš€ ì‹ ê·œ (ì§€ì ì¸¡ëŸ‰)', color: '#ec4899' },
                { id: 'cust_cs', title: 'ğŸš€ ì‹ ê·œ (ì§€ì ì „ì‚°)', color: '#f59e0b' }
            ];

            configs.forEach(conf => {
                html += `<div id="header-${conf.id}" class="category-header" style="color:${conf.color}; border-color:${conf.color}">
                    ${conf.title} <span>${data[conf.id].length}</span>
                    <button onclick="saveToServer('${conf.id}')" style="font-size:0.7rem; padding:3px 8px; border:1px solid ${conf.color}; background:transparent; color:${conf.color}; border-radius:4px; cursor:pointer;">ì§€ê¸ˆ ì €ì¥</button>
                </div>`;
                html += data[conf.id].map((q, idx) => `
                    <div class="admin-card glass ${currentEdit.cat === conf.id && currentEdit.idx === idx ? 'active' : ''}" onclick="loadQuestion('${conf.id}', ${idx})">
                        <div style="font-size:0.85rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                            <span class="badge ${q.difficulty}">${q.difficulty}</span> ${q.text}
                        </div>
                    </div>
                `).join('');
            });
            list.innerHTML = html;
        }

        function loadQuestion(cat, idx) {
            currentEdit = { cat, idx };
            const q = data[cat][idx];
            document.getElementById('no-selection').classList.add('hidden');
            document.getElementById('editor-form').classList.remove('hidden');
            document.getElementById('edit-id').value = q.id;
            document.getElementById('edit-text').value = q.text;
            document.getElementById('edit-subject').value = q.subject;
            document.getElementById('edit-source').value = q.source || (cat.startsWith('off') ? 'ê¸°ì¶œ' : 'AI');
            document.getElementById('edit-image').value = q.image || '';
            updatePreview(q.image);
            document.getElementById('edit-difficulty').value = q.difficulty || 'í•˜';
            document.getElementById('edit-answer').value = q.answer;
            document.getElementById('edit-explanation').value = q.explanation || '';
            renderList();
        }

        function saveChanges() {
            if (currentEdit.idx === -1) return;
            const q = data[currentEdit.cat][currentEdit.idx];
            q.text = document.getElementById('edit-text').value;
            q.subject = document.getElementById('edit-subject').value;
            q.source = document.getElementById('edit-source').value;
            q.image = document.getElementById('edit-image').value || null;
            q.difficulty = document.getElementById('edit-difficulty').value;
            q.answer = parseInt(document.getElementById('edit-answer').value);
            q.explanation = document.getElementById('edit-explanation').value;
            document.getElementById('save-status').innerText = "ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ [ì €ì¥] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì„œë²„ì— ë°˜ì˜í•˜ì„¸ìš”.";
            renderList();
        }

        function addNewQuestion() {
            const subject = prompt("ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš” (1:ì§€ì ì¸¡ëŸ‰, 2:ì§€ì ì „ì‚°í•™ê°œë¡ )", "1") === "2" ? "ì§€ì ì „ì‚°í•™ê°œë¡ " : "ì§€ì ì¸¡ëŸ‰";
            const cat = subject === "ì§€ì ì¸¡ëŸ‰" ? "cust_survey" : "cust_cs";
            const newQ = { id: `new_${Date.now()}`, num: "ì‹ ê·œ", text: "ë‚´ìš©ì…ë ¥", options: ["1", "2", "3", "4"], answer: 1, explanation: "", subject, source: "ì˜ˆìƒ", difficulty: "ì¤‘", image: null };
            data[cat].unshift(newQ);
            loadQuestion(cat, 0);

            const status = document.getElementById('save-status');
            status.innerText = "ì‹ ê·œ ë¬¸í•­ ìƒì„±. ë‚´ìš©ì„ ì±„ìš´ í›„ ìƒë‹¨ ì €ì¥ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.";
        }

        async function processImport() {
            const area = document.getElementById('import-area');
            const subject = document.getElementById('import-subject').value;
            const cat = subject === "ì§€ì ì¸¡ëŸ‰" ? "cust_survey" : "cust_cs";

            try {
                const items = JSON.parse(area.value);
                const newItems = Array.isArray(items) ? items : [items];

                newItems.forEach(q => {
                    // Unique ID generation
                    q.id = q.id || `ai_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                    q.source = q.source || "AI";
                    q.subject = subject;
                    data[cat].unshift(q);
                });

                renderList();
                document.getElementById('import-modal').classList.add('hidden');

                // Auto-save immediately
                await saveToServer(cat, true); // true = silent mode
                alert(`${newItems.length}ê°œì˜ ë¬¸ì œê°€ ì¶”ê°€ë˜ê³  ì„œë²„ì— ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                area.value = ''; // clear input

            } catch (e) {
                console.error(e);
                alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        async function saveToServer(cat, silent = false) {
            const payload = {
                mode: cat,
                questions: data[cat]
            };

            try {
                const res = await fetch('/save_questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (!silent) {
                    if (result.success) {
                        alert('âœ… ì„œë²„ ì €ì¥ ì„±ê³µ! ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì¦‰ì‹œ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + result.error);
                    }
                }
            } catch (e) {
                if (!silent) {
                    console.error(e);
                    alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜. server.pyê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
                }
            }
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function checkLogin() {
            const id = document.getElementById('admin-id').value;
            const pw = document.getElementById('admin-pw').value;

            // í•´ì‹œê°’ (ID: admin, PW: admin205)
            const validIdHash = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";
            const validPwHash = "a689455e22f69acb11046815bc1bdf275d7ad909856a99f7ace2b801cb0867af";

            try {
                const idHash = await sha256(id);
                const pwHash = await sha256(pw);

                if (idHash === validIdHash && pwHash === validPwHash) {
                    if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                        alert("âš ï¸ [ì£¼ì˜] ì›¹(GitHub)ì—ì„œëŠ” ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤! âš ï¸\n\në°ì´í„° ì €ì¥ì€ 'ë¡œì»¬ ì„œë²„(server.py)'ê°€ ì‹¤í–‰ëœ\nì»´í“¨í„°ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.\n\ní˜„ì¬ í˜ì´ì§€ëŠ” 'ì¡°íšŒ ì „ìš©'ì…ë‹ˆë‹¤.");
                    }
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                } else {
                    document.getElementById('login-error').innerText = "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.";
                }
            } catch (e) {
                console.error("Login Error", e);
                alert("ë³´ì•ˆ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }


        document.getElementById('admin-pw').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') checkLogin();
        });

        function updatePreview(path) {
            const preview = document.getElementById('edit-img-preview');
            if (path) {
                preview.innerHTML = `<img src="${path}" onerror="this.parentElement.innerHTML='<span class=\"no-img-msg\">ì´ë¯¸ì§€ ê²½ë¡œ ìš”ë¥˜</span>'">`;
            } else {
                preview.innerHTML = '<span class="no-img-msg">ì´ë¯¸ì§€ ì—†ìŒ</span>';
            }
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const fileName = input.files[0].name;
                const path = 'images/' + fileName;
                document.getElementById('edit-image').value = path;
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('edit-img-preview').innerHTML = `<img src="${e.target.result}">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
    </script>
</body>

</html>